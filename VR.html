<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quest VR Online Chess</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
<style>
body{margin:0; background:#0b0f1a; color:white; font-family:Inter,sans-serif;}
button,input{width:100%; margin:6px 0; padding:12px; border-radius:10px; border:none; background:#1c2742; color:white;}
button:hover{background:#2c3a66; cursor:pointer;}
#capturedWhite, #capturedBlack { position:fixed; bottom:0; width:200px; height:80px; display:flex; flex-wrap:wrap; padding:4px; background:#121a2b88; border-radius:8px; }
#capturedWhite { left:0; }
#capturedBlack { right:0; }
</style>
</head>
<body>
<div id="menu">
<h1>â™Ÿ Quest VR Online Chess</h1>
<input id="username" placeholder="Temporary username">
<button onclick="startVROnline()">Host Online VR Game</button>
<input id="joinId" placeholder="Host Username">
<button onclick="joinVROnline()">Join Online VR Game</button>
</div>

<div id="capturedWhite"></div>
<div id="capturedBlack"></div>

<script>
let boardState, turn='w', peer, conn, myColor='both';
let pieceEntities = {}, capturedWhite = [], capturedBlack = [];
const squareSize = 0.25;
const animDuration = 500;
const pieceModels = {
  r:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/rook.glb',
  n:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/knight.glb',
  b:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/bishop.glb',
  q:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/queen.glb',
  k:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/king.glb',
  p:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/pawn.glb',
  R:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/rook.glb',
  N:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/knight.glb',
  B:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/bishop.glb',
  Q:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/queen.glb',
  K:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/king.glb',
  P:'https://cdn.jsdelivr.net/gh/KenanZ/3d-chess-models/pawn.glb'
};

function initBoard(){
 boardState=["rnbqkbnr","pppppppp","........","........","........","........","PPPPPPPP","RNBQKBNR"];
 updateVR();
}

function startVROnline(){
 myColor='w';
 const name=username.value||'host';
 peer=new Peer(name);
 peer.on('connection',c=>{conn=c; setupConn();});
 startVRScene();
 initBoard();
}

function joinVROnline(){
 myColor='b';
 peer=new Peer();
 peer.on('open',()=>{conn=peer.connect(joinId.value); setupConn();});
 startVRScene();
 initBoard();
}

function setupConn(){
 conn.on('data',d=>{boardState=d.boardState; turn=d.turn; capturedWhite=d.capturedWhite||[]; capturedBlack=d.capturedBlack||[]; updateVR();});
}

function startVRScene(){
 document.body.innerHTML=`
 <a-scene vr-mode-ui='enabled:true'>
   <a-entity camera look-controls position='0 1.6 3'></a-entity>
   <a-entity laser-controls='hand:left'></a-entity>
   <a-entity laser-controls='hand:right'></a-entity>
   <a-entity id='chessBoard' position='0 0 -1' scale='0.6 0.6 0.6'></a-entity>
 </a-scene>`;
 makeVRBoard();
}

function makeVRBoard(){
 const board = document.getElementById('chessBoard');
 for(let y=0;y<8;y++){
   for(let x=0;x<8;x++){
     let tile=document.createElement('a-box');
     tile.setAttribute('width',squareSize);
     tile.setAttribute('height',0.02);
     tile.setAttribute('depth',squareSize);
     tile.setAttribute('position',`${(x-3.5)*squareSize} 0 ${(y-3.5)*squareSize}`);
     tile.setAttribute('color',(x+y)%2?'#333':'#ddd');
     tile.dataset.x=x; tile.dataset.y=y;
     board.appendChild(tile);
   }
 }
 updateVR();
}

function updateVR(){
 const board = document.getElementById('chessBoard');
 if(!board) return;
 Object.values(pieceEntities).forEach(e=>e.parentNode.removeChild(e));
 pieceEntities={};
 for(let y=0;y<8;y++){
   for(let x=0;x<8;x++){
     let c = boardState[y][x];
     if(c=='.') continue;
     let e=document.createElement('a-entity');
     e.setAttribute('gltf-model', pieceModels[c]);
     e.setAttribute('scale', '0.05 0.05 0.05');
     e.setAttribute('position', `${(x-3.5)*squareSize} 0.05 ${(y-3.5)*squareSize}`);
     e.setAttribute('grabbable','');
     e.dataset.x=x; e.dataset.y=y;
     board.appendChild(e);
     pieceEntities[`${x},${y}`]=e;
   }
 }
 updateCapturedDisplay();
}

function animateMove(entity, targetPos){
 entity.setAttribute('animation__move', `property: position; to: ${targetPos.x} ${targetPos.y} ${targetPos.z}; dur: ${animDuration}; easing: easeInOutQuad`);
}

function handleMove(x1,y1,x2,y2){
 if(!canMove(x1,y1,x2,y2)) return;
 let target = boardState[y2][x2];
 if(target !='.') {
   if(target==target.toUpperCase()) capturedWhite.push(target);
   else capturedBlack.push(target);
 }
 let entity = pieceEntities[`${x1},${y1}`];
 let posX = (x2-3.5)*squareSize;
 let posZ = (y2-3.5)*squareSize;
 animateMove(entity, {x:posX, y:0.05, z:posZ});
 setTimeout(()=> move(x1,y1,x2,y2), animDuration);
 updateCapturedDisplay();
}

function updateCapturedDisplay(){
 const cw = document.getElementById('capturedWhite');
 const cb = document.getElementById('capturedBlack');
 cw.innerHTML=''; cb.innerHTML='';
 capturedWhite.forEach(c=>{let e=document.createElement('span'); e.textContent=c; cw.appendChild(e);});
 capturedBlack.forEach(c=>{let e=document.createElement('span'); e.textContent=c; cb.appendChild(e);});
}

let vrSelected=null;
function vrPick(x,y){
 if(vrSelected){
   handleMove(vrSelected.x,vrSelected.y,x,y);
   vrSelected=null;
 } else {
   let p = boardState[y][x];
   if(p!='.' && ((turn=='w' && p==p.toUpperCase())||(turn=='b' && p==p.toLowerCase()))) vrSelected={x,y};
 }
}

function move(x1,y1,x2,y2){
 let r=[...boardState[y1]]; let p=r[x1]; r[x1]='.'; boardState[y1]=r.join('');
 r=[...boardState[y2]]; r[x2]=p; boardState[y2]=r.join('');
 turn=turn=='w'?'b':'w';
 if(conn) conn.send({boardState,turn,capturedWhite,capturedBlack});
 updateVR();
}

function canMove(x1,y1,x2,y2){
 let p=boardState[y1][x1];
 if(boardState[y2][x2]!='.' && (p.toUpperCase()===boardState[y2][x2].toUpperCase())) return false;
 let dx=x2-x1, dy=y2-y1;
 if(p.toLowerCase()=='p'){
  let dir = p===p.toUpperCase()?-1:1, startRow = p===p.toUpperCase()?6:1;
  if(dx===0 && dy===dir && boardState[y2][x2]=='.') return true;
  if(dx===0 && y1===startRow && dy===dir*2 && boardState[y1+dir][x1]=='.') return true;
  if(Math.abs(dx)===1 && dy===dir && boardState[y2][x2]!='.') return true;
  return false;
 }
 return true;
}

initBoard();
</script>
</body>
</html>
